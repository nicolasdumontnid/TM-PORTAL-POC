<div class="visual-patient-container">
  <div class="visual-patient-header">
    <h1>Visual Patient</h1>
    <button class="close-btn" (click)="onClose()">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <div class="burger-menu-container">
    <button class="burger-menu-btn" (click)="toggleBurgerMenu()">
      <i class="fas fa-bars"></i>
    </button>

    <div class="burger-menu" [class.show]="showBurgerMenu$ | async">
      <a href="javascript:void(0)" (click)="addBlock('patient-info')">Patient Information</a>
      <a href="javascript:void(0)" (click)="addBlock('radiological-request')">Radiological Request</a>
      <a href="javascript:void(0)" (click)="addBlock('ai-summary')">IA Summary</a>
      <a href="javascript:void(0)" (click)="addBlock('radio-report')">Last Radio Report Conclusion</a>
      <a href="javascript:void(0)" (click)="addBlock('patient-records')">Top 10 Patient Record Information</a>
      <a href="javascript:void(0)" (click)="addBlock('calendar-map')">Calendar Map</a>
      <a href="javascript:void(0)" (click)="addBlock('images-preview')">All Images preview</a>
    </div>
  </div>

  <div class="blocks-container">
    <div *ngFor="let block of visibleBlocks$ | async; trackBy: trackByBlockId" class="patient-block">
      <div class="block-header">
        <h3>{{block.title}}</h3>
        <button class="remove-block-btn" (click)="removeBlock(block.id)">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Patient Information Block -->
      <div *ngIf="block.type === 'patient-info'" class="block-content patient-info-content">
        <div *ngIf="patientInfo$ | async as patientInfo" class="patient-info">
          <img [src]="patientInfo.photo" [alt]="patientInfo.name" class="patient-photo">
          <div class="patient-details">
            <div class="detail-row">
              <span class="label">Name:</span>
              <span class="value">{{patientInfo.name}}</span>
            </div>
            <div class="detail-row">
              <span class="label">Date of Birth:</span>
              <span class="value">{{patientInfo.dateOfBirth | date:'dd/MM/yyyy'}}</span>
            </div>
            <div class="detail-row">
              <span class="label">Patient Number:</span>
              <span class="value">{{patientInfo.patientNumber}}</span>
            </div>
            <div class="detail-row">
              <span class="label">Exam Number:</span>
              <span class="value">{{patientInfo.examNumber}}</span>
            </div>
            <div class="detail-row">
              <span class="label">Gender:</span>
              <span class="value">{{patientInfo.gender}}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Radiological Request Block -->
      <div *ngIf="block.type === 'radiological-request'" class="block-content">
        <div *ngIf="radiologicalRequest$ | async as request">
          <p><strong>Request:</strong> {{request.description}}</p>
        </div>
      </div>

      <!-- AI Summary Block -->
      <div *ngIf="block.type === 'ai-summary'" class="block-content">
        <div *ngIf="aiSummary$ | async as summary">
          <div class="badges">
            <span class="badge medical-sector">{{summary.medicalSector}}</span>
            <span class="badge status">{{summary.status}}</span>
          </div>
          <p class="summary-text">{{summary.healthSummary}}</p>
        </div>
      </div>

      <!-- Radio Report Block -->
      <div *ngIf="block.type === 'radio-report'" class="block-content">
        <div *ngIf="radioReport$ | async as report">
          <div class="badges">
            <span class="badge filter-badge">Radiology</span>
            <span class="badge filter-badge">Recent</span>
          </div>
          <p><strong>Conclusion:</strong> {{report.conclusion}}</p>
        </div>
      </div>

      <!-- Patient Records Block -->
      <div *ngIf="block.type === 'patient-records'" class="block-content">
        <div class="badges">
          <span 
            class="badge filter-badge"
            [class.active]="(recordsFilter$ | async) === 'All'"
            (click)="setRecordsFilter('All')"
          >All</span>
          <span 
            class="badge filter-badge"
            [class.active]="(recordsFilter$ | async) === 'Imaging'"
            (click)="setRecordsFilter('Imaging')"
          >Imaging</span>
          <span 
            class="badge filter-badge"
            [class.active]="(recordsFilter$ | async) === 'Lab'"
            (click)="setRecordsFilter('Lab')"
          >Lab</span>
          <span 
            class="badge filter-badge"
            [class.active]="(recordsFilter$ | async) === 'Reports'"
            (click)="setRecordsFilter('Reports')"
          >Reports</span>
        </div>
        <div class="records-list">
          <div *ngFor="let record of filteredPatientRecords$ | async" class="record-item">
            <div class="record-header">
              <span class="record-date">{{record.date | date:'dd/MM/yyyy'}}</span>
              <span class="record-name">{{record.examName}}</span>
            </div>
            <p class="record-description">{{record.description}}</p>
          </div>
        </div>
        <div class="block-footer">
          <button class="see-all-btn">see all -></button>
        </div>
      </div>

      <!-- Calendar Map Block -->
      <div *ngIf="block.type === 'calendar-map'" class="block-content calendar-map-content">
        <!-- GRAPHIC_FILTER Component -->
        <div class="graphic-filter">
          <!-- View Line -->
          <div class="filter-line">
            <span class="filter-label">View</span>
            <div class="filter-buttons">
              <button 
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.view === 'department'"
                (click)="setGraphicView('department')"
              >By Department</button>
              <button 
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.view === 'anatomy'"
                (click)="setGraphicView('anatomy')"
              >By Anatomy</button>
            </div>
          </div>

          <!-- Departments Line -->
          <div 
            class="filter-line"
            *ngIf="(graphicFilter$ | async)?.view === 'department'"
          >
            <span class="filter-label">DÃ©partements</span>
            <div class="filter-buttons">
              <button 
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.department === 'ALL'"
                (click)="setDepartmentFilter('ALL')"
              >ALL</button>
              <button 
                *ngFor="let dept of departments$ | async"
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.department === dept.name"
                (click)="setDepartmentFilter(dept.name)"
              >{{dept.name}}</button>
            </div>
          </div>

          <!-- Anatomy Line -->
          <div 
            class="filter-line"
            *ngIf="(graphicFilter$ | async)?.view === 'anatomy'"
          >
            <span class="filter-label">Anatomy</span>
            <div class="filter-buttons">
              <button 
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.anatomy === 'ALL'"
                (click)="setAnatomyFilter('ALL')"
              >ALL</button>
              <button 
                *ngFor="let region of anatomyRegions$ | async"
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.anatomy === region.name"
                (click)="setAnatomyFilter(region.name)"
              >{{region.name}}</button>
              <button 
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.anatomy === 'Others'"
                (click)="setAnatomyFilter('Others')"
              >Others</button>
            </div>
          </div>

          <!-- Timeline Line -->
          <div class="filter-line">
            <span class="filter-label">Timeline</span>
            <div class="filter-buttons">
              <button 
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.timeline === 'ALL'"
                (click)="setTimelineFilter('ALL')"
              >ALL</button>
              <button 
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.timeline === '1 Week'"
                (click)="setTimelineFilter('1 Week')"
              >1 Week</button>
              <button 
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.timeline === '1 Month'"
                (click)="setTimelineFilter('1 Month')"
              >1 Month</button>
              <button 
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.timeline === '3 Months'"
                (click)="setTimelineFilter('3 Months')"
              >3 Months</button>
              <button 
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.timeline === '6 Months'"
                (click)="setTimelineFilter('6 Months')"
              >6 Months</button>
              <button 
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.timeline === '1 Year'"
                (click)="setTimelineFilter('1 Year')"
              >1 Year</button>
              <button 
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.timeline === '3 Years'"
                (click)="setTimelineFilter('3 Years')"
              >3 Years</button>
              <button 
                class="filter-btn"
                [class.active]="(graphicFilter$ | async)?.timeline === 'More than 3 years'"
                (click)="setTimelineFilter('More than 3 years')"
              >More than 3 years</button>
            </div>
          </div>
        </div>
        
        <div class="calendar-map-body">
          <!-- Department Labels (visible only in department view) -->
          <div class="department-labels" 
               *ngIf="(graphicFilter$ | async)?.view === 'department'"
               [style.--department-count]="departmentsList.length"
               #departmentLabelsScroll
               (scroll)="onDepartmentLabelsScroll($event)">
            <div *ngFor="let dept of departmentsList; let i = index" 
                 class="department-label"
                 [style.top.px]="i * 40 + 10">
              {{dept}}
            </div>
          </div>
          
          <!-- Body Diagram (visible only in anatomy view) -->
          <div class="body-diagram" *ngIf="(graphicFilter$ | async)?.view === 'anatomy'">
            <img 
              src="assets/public/images/skeleton+skin.svg" 
              alt="Human body diagram"
              class="human-body-svg"
            />
          </div>
          
          <div class="timeline-chart">
            <div class="chart-container-wrapper">
              <div class="chart-scroll-container" #chartScrollContainer>
                <div class="chart-vertical-scroll" #chartVerticalScroll (scroll)="onChartVerticalScroll($event)">
                  <div class="chart-horizontal-scroll">
                    <div class="chart-container"
                         [class.department-view]="(graphicFilter$ | async)?.view === 'department'"
                         [class.anatomy-view]="(graphicFilter$ | async)?.view === 'anatomy'"
                         [style.--department-count]="(graphicFilter$ | async)?.view === 'department' ? (getYAxisLabels() | async)?.length || 0 : 0">
                    <ng-container *ngIf="filteredExamPoints$ | async as examPoints">
                      <!-- Y-axis labels -->
                      <div class="y-axis"
                           [class.department-view]="(graphicFilter$ | async)?.view === 'department'"
                           [class.anatomy-view]="(graphicFilter$ | async)?.view === 'anatomy'"
                           [style.--department-count]="(graphicFilter$ | async)?.view === 'department' ? (getYAxisLabels() | async)?.length || 0 : 0">
                        <div *ngFor="let label of (getYAxisLabels() | async) || []; let i = index; trackBy: trackByIndex" 
                             class="y-axis-label"
                             [style.top.px]="(graphicFilter$ | async)?.view === 'department' ? (i + 0.5) * 40 - 10 : null"
                             [style.top.%]="(graphicFilter$ | async)?.view === 'anatomy' ? ((i + 0.5) / ((getYAxisLabels() | async)?.length || 1)) * 100 : null">
                          {{label}}
                        </div>
                      </div>
                      
                      <!-- Chart area -->
                      <div class="chart-area"
                           [class.department-view]="(graphicFilter$ | async)?.view === 'department'"
                           [class.anatomy-view]="(graphicFilter$ | async)?.view === 'anatomy'"
                           [style.--department-count]="(graphicFilter$ | async)?.view === 'department' ? (getYAxisLabels() | async)?.length || 0 : 0">
                        <!-- Region lines -->
                        <div *ngFor="let label of (getYAxisLabels() | async) || []; let i = index; trackBy: trackByIndex" 
                             class="region-line"
                             [style.top.px]="(graphicFilter$ | async)?.view === 'department' ? i * 40 : undefined"
                             [style.height.px]="(graphicFilter$ | async)?.view === 'department' ? 40 : undefined"
                             [style.top.%]="(graphicFilter$ | async)?.view === 'anatomy' ? (i / ((getYAxisLabels() | async)?.length || 1)) * 100 : undefined"
                             [style.height.%]="(graphicFilter$ | async)?.view === 'anatomy' ? (100 / ((getYAxisLabels() | async)?.length || 1)) : undefined"
                             [class.hovered]="hoveredRegion === label || isRegionFiltered(label)"
                             (mouseenter)="onRegionHover(label)"
                             (mouseleave)="onRegionLeave()">
                        </div>
                        
                        <!-- TODAY line -->
                        <div class="today-line"
                             [style.left.%]="getTodayPosition(examPoints)"
                             [style.height.px]="(graphicFilter$ | async)?.view === 'department' ? ((getYAxisLabels() | async)?.length || 0) * 40 : null"
                             [style.height]="(graphicFilter$ | async)?.view === 'anatomy' ? '100%' : null">
                          <div class="today-label">TODAY</div>
                        </div>
                        
                        <!-- Exam points -->
                        <div *ngFor="let examPoint of examPoints" 
                             class="exam-point"
                             [class.future-point]="examPoint.isFuture"
                             [style.left.%]="getExamPointPosition(examPoint, examPoints).x"
                             [style.top.px]="(graphicFilter$ | async)?.view === 'department' ? getExamPointPosition(examPoint, examPoints).y : undefined"
                             [style.top.%]="(graphicFilter$ | async)?.view === 'anatomy' ? getExamPointPosition(examPoint, examPoints).y : undefined"
                             (mouseenter)="onExamPointHover(examPoint, $event)"
                             (mouseleave)="onExamPointLeave()"
                             (click)="openReporting(examPoint)">
                          <div class="exam-point-label" 
                               (mouseenter)="onExamPointHover(examPoint, $event)"
                               (mouseleave)="onExamPointLeave()">
                            {{examPoint.examName}}<br>
                            <small>{{examPoint.date | date:'dd/MM/yy'}}</small>
                          </div>
                        </div>
                      </div>
                    </ng-container>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- X-axis (fixed at bottom of chart) -->
              <div class="x-axis">
                <ng-container *ngIf="filteredExamPoints$ | async as examPoints">
                  <div *ngFor="let timeLabel of getTimelineLabels(examPoints)" 
                       class="x-axis-label"
                       [style.left.%]="timeLabel.position">
                    {{timeLabel.label}}
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Images Preview Block -->
      <div *ngIf="block.type === 'images-preview'" class="block-content">
        <div class="images-container">
          <div *ngFor="let dateGroup of imagesByDate$ | async" class="date-group">
            <h4 class="date-header">{{dateGroup.displayDate}}</h4>
            <div class="images-grid">
              <div *ngFor="let image of dateGroup.images" class="image-thumbnail">
                <img [src]="image.url" [alt]="image.filename" class="medical-image" (click)="openReporting(undefined, image)">
                <p class="image-filename">{{image.filename}}</p>
              </div>
            </div>
          </div>
        </div>
        <div class="block-footer">
          <button class="see-all-btn">see all -></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Exam Point Tooltip -->
  <div *ngIf="hoveredExamPoint"
       class="exam-tooltip"
       [style.left.px]="tooltipPosition.x + 10"
       [style.top.px]="tooltipPosition.y - 10"
       (mouseenter)="onTooltipEnter()"
       (mouseleave)="onTooltipLeave()"
       (click)="openReporting(hoveredExamPoint)">
    <div class="tooltip-header">
      <h4>{{hoveredExamPoint.examName}}</h4>
      <p class="tooltip-date">{{hoveredExamPoint.date | date:'dd/MM/yyyy'}}</p>
    </div>
    <div class="tooltip-content">
      <p><strong>Department:</strong> {{hoveredExamPoint.department}}</p>
      <p><strong>Anatomical Region:</strong> {{hoveredExamPoint.anatomy}}</p>
      <p><strong>Description:</strong> {{hoveredExamPoint.description}}</p>
    </div>
    <div class="tooltip-thumbnails" *ngIf="getExamThumbnails(hoveredExamPoint).length > 0">
      <h5>Medical Images:</h5>
      <div class="thumbnails-grid">
        <img *ngFor="let thumbnail of getExamThumbnails(hoveredExamPoint)"
             [src]="thumbnail.url"
             [alt]="thumbnail.filename"
             class="tooltip-thumbnail">
      </div>
    </div>
  </div>
</div>