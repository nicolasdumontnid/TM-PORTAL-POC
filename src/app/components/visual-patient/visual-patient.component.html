<div class="visual-patient-container">
  <div class="visual-patient-header">
    <h1>Visual Patient</h1>
    <button class="close-btn" (click)="onClose()">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <div class="burger-menu-container">
    <button class="burger-menu-btn" (click)="toggleBurgerMenu()">
      <i class="fas fa-bars"></i>
    </button>
    
    <div class="burger-menu" [class.show]="showBurgerMenu">
      <a href="javascript:void(0)" (click)="addBlock('patient-info')">Patient Information</a>
      <a href="javascript:void(0)" (click)="addBlock('radiological-request')">Radiological Request</a>
      <a href="javascript:void(0)" (click)="addBlock('ai-summary')">IA Summary</a>
      <a href="javascript:void(0)" (click)="addBlock('radio-report')">Last Radio Report Conclusion</a>
      <a href="javascript:void(0)" (click)="addBlock('patient-records')">Top 10 Patient Record Information</a>
      <a href="javascript:void(0)" (click)="addBlock('calendar-map')">Calendar Map</a>
      <a href="javascript:void(0)" (click)="addBlock('images-preview')">All Images preview</a>
    </div>
  </div>

  <div class="blocks-container">
    <div *ngFor="let block of visibleBlocks$ | async; trackBy: trackByBlockId" class="patient-block">
      <div class="block-header">
        <h3>{{block.title}}</h3>
        <button class="remove-block-btn" (click)="removeBlock(block.id)">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Patient Information Block -->
      <div *ngIf="block.type === 'patient-info'" class="block-content">
        <app-patient-info-block [patientInfo$]="patientInfo$"></app-patient-info-block>
      </div>

      <!-- Radiological Request Block -->
      <div *ngIf="block.type === 'radiological-request'" class="block-content">
        <div *ngIf="radiologicalRequest$ | async as request">
          <p><strong>Request:</strong> {{request.description}}</p>
        </div>
      </div>

      <!-- AI Summary Block -->
      <div *ngIf="block.type === 'ai-summary'" class="block-content">
        <app-ai-summary-block [aiSummary$]="aiSummary$"></app-ai-summary-block>
      </div>

      <!-- Radio Report Block -->
      <div *ngIf="block.type === 'radio-report'" class="block-content">
        <div *ngIf="radioReport$ | async as report">
          <div class="badges">
            <span class="badge filter-badge">Radiology</span>
            <span class="badge filter-badge">Recent</span>
          </div>
          <p><strong>Conclusion:</strong> {{report.conclusion}}</p>
        </div>
      </div>

      <!-- Patient Records Block -->
      <div *ngIf="block.type === 'patient-records'" class="block-content">
        <app-patient-records-block 
          [filteredPatientRecords$]="filteredPatientRecords$"
          [recordsFilter$]="recordsFilter$"
          (filterChange)="setRecordsFilter($event)">
        </app-patient-records-block>
      </div>

      <!-- Calendar Map Block -->
      <div *ngIf="block.type === 'calendar-map'" class="block-content">
        <app-calendar-map-block
          [graphicFilter$]="graphicFilter$"
          [departments$]="departments$"
          [anatomyRegions$]="anatomyRegions$"
          [filteredExamPoints$]="filteredExamPoints$"
          [departmentsList]="departmentsList"
          [hoveredRegion]="hoveredRegion"
          (graphicViewChange)="setGraphicView($event)"
          (departmentFilterChange)="setDepartmentFilter($event)"
          (anatomyFilterChange)="setAnatomyFilter($event)"
          (timelineFilterChange)="setTimelineFilter($event)"
          (examPointClick)="openReporting($event)"
          (examPointHover)="onExamPointHover($event.examPoint, $event.event)"
          (examPointLeave)="onExamPointLeave()"
          (regionHover)="onRegionHover($event)"
          (regionLeave)="onRegionLeave()"
          (departmentLabelsScroll)="onDepartmentLabelsScroll($event)"
          (chartVerticalScroll)="onChartVerticalScroll($event)">
        </app-calendar-map-block>
      </div>

      <!-- Images Preview Block -->
      <div *ngIf="block.type === 'images-preview'" class="block-content">
        <app-images-preview-block 
          [imagesByDate$]="imagesByDate$"
          (imageClick)="openReporting(undefined, $event)">
        </app-images-preview-block>
      </div>
    </div>
  </div>

  <!-- Exam Point Tooltip -->
  <div *ngIf="hoveredExamPoint" 
       class="exam-tooltip"
       [style.left.px]="tooltipPosition.x + 10"
       [style.top.px]="tooltipPosition.y - 10"
       (mouseenter)="onTooltipEnter()"
       (mouseleave)="onTooltipLeave()">
    <div class="tooltip-header">
      <h4>{{hoveredExamPoint.examName}}</h4>
      <p class="tooltip-date">{{hoveredExamPoint.date | date:'dd/MM/yyyy'}}</p>
    </div>
    <div class="tooltip-content">
      <p><strong>Department:</strong> {{hoveredExamPoint.department}}</p>
      <p><strong>Anatomical Region:</strong> {{hoveredExamPoint.anatomicalRegion}}</p>
      <p><strong>Description:</strong> {{hoveredExamPoint.description}}</p>
    </div>
    <div class="tooltip-thumbnails" *ngIf="getExamThumbnails(hoveredExamPoint).length > 0">
      <h5>Medical Images:</h5>
      <div class="thumbnails-grid">
        <img *ngFor="let thumbnail of getExamThumbnails(hoveredExamPoint)" 
             [src]="thumbnail.url" 
             [alt]="thumbnail.filename"
             class="tooltip-thumbnail">
      </div>
    </div>
  </div>
</div>